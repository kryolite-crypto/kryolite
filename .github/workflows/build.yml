name: build

on:
  push:

jobs:
  builder:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $ --password-stdin
      - run: docker build -f Dockerfile.builder -t ghcr.io/${GITHUB_REPOSITORY}/builder:latest .
      - run: docker push ghcr.io/${GITHUB_REPOSITORY}/builder:latest
  build:
    needs: builder
    strategy:
      matrix:
        component: [daemon, holvi-wallet, louhi-miner]
        runtime: [linux-x64, linux-arm64, mac-x64, mac-arm64, win-x64]
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $ --password-stdin
      - run: docker pull "ghcr.io/${GITHUB_REPOSITORY}/builder:latest"
      - run: docker tag "ghcr.io/${GITHUB_REPOSITORY}/builder:latest" builder
      - run: mkdir dist
      - run: docker run -v "$(pwd)/dist:/dist" builder "${{ matrix.component }}" "${{ matrix.runtime }}" /dist
      - run: ls -lah dist
      - uses: actions/upload-artifact@v3
        with:
          path: dist
  release:
    needs: build
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/download-artifact@v3
      - run: ls -lah
      - run: tree
